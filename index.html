<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Submit Info</title>
  <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 6px;
    }
    th {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <h1>Submit your info</h1>
  <form id="myForm">
    <label>Name: <input name="name" required></label><br>
    <label>Email: <input name="email" type="email" required></label><br>
    <label>Message:<br><textarea name="message" required></textarea></label><br>
    <button type="submit">Send</button>
  </form>
  <p id="response"></p>

  <h2>Previous Submissions</h2>
  <div id="submissionList">Loading...</div>

  <script>
    // Get ?sheetId=... from the URL
    function getSheetIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("sheetId");
    }

    const SHEET_ID = getSheetIdFromUrl();
    if (!SHEET_ID) {
      document.body.innerHTML = "<p style='color:red'>❌ No sheetId provided in the URL.</p>";
      throw new Error("Missing sheetId");
    }

    const SCRIPT_BASE = "https://script.google.com/macros/s/AKfycbw9J5AnKEQDozmX5H5-bqe7JM7MWs4VSGiASGFKJ1rCIhPdmz1AStSpGv964pRQsbeuhg/exec";
    const GET_URL = `${SCRIPT_BASE}?sheetId=${SHEET_ID}`;

    async function loadSubmissions() {
      try {
        const res = await fetch(GET_URL);
        const data = await res.json();
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');

        if (data.length === 0) {
          document.getElementById('submissionList').textContent = "No submissions yet.";
          return;
        }

        // Create header row
        const headerRow = document.createElement('tr');
        Object.keys(data[0]).forEach(key => {
          const th = document.createElement('th');
          th.textContent = key;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // Create data rows
        data.forEach(row => {
          const tr = document.createElement('tr');
          Object.values(row).forEach(val => {
            const td = document.createElement('td');
            td.textContent = val;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        const container = document.getElementById('submissionList');
        container.innerHTML = '';
        container.appendChild(table);

      } catch (err) {
        document.getElementById('submissionList').textContent = "❌ Failed to load submissions.";
        console.error(err);
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      loadSubmissions();

      document.getElementById('myForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        formData.append("sheetId", SHEET_ID); // Pass sheetId to backend

        try {
          const res = await fetch(SCRIPT_BASE, {
            method: "POST",
            body: formData
          });

          const text = await res.text();
          document.getElementById('response').textContent = text;

          form.reset();
          setTimeout(loadSubmissions, 1000); // Refresh table after new submission
        } catch (err) {
          console.error("❌ Error submitting form:", err);
          document.getElementById('response').textContent = "❌ Submission failed.";
        }
      });
    });
  </script>
</body>
</html>
